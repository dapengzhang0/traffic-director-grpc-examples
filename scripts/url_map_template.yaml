# Populate project ID as: PROJECT_ID = $(gcloud config list --format 'value(core.project)').

defaultService: projects/${PROJECT_ID}/global/backendServices/${TEST_PREFIX}grpcwallet-account-service
name: ${TEST_PREFIX}grpcwallet-url-map

hostRules:
  - hosts:
      - "${TEST_PREFIX}account.grpcwallet.io:${TEST_PORT}"
    pathMatcher: grpcwallet-account-path-matcher
  - hosts:
      - "${TEST_PREFIX}stats.grpcwallet.io:${TEST_PORT}"
    pathMatcher: grpcwallet-stats-path-matcher
  - hosts:
      - "${TEST_PREFIX}wallet.grpcwallet.io:${TEST_PORT}"
    pathMatcher: grpcwallet-wallet-path-matcher

pathMatchers:
  - defaultService: projects/${PROJECT_ID}/global/backendServices/${TEST_PREFIX}grpcwallet-account-service
    name: grpcwallet-account-path-matcher
    routeRules:
    - matchRules:
      - fullPathMatch: /grpc.examples.wallet.account/GetUserInfo
        headerMatches:
        - headerName: route
          exactMatch: account-fault
      priority: 0
      routeAction:
        weightedBackendServices:
        - backendService: projects/${PROJECT_ID}/global/backendServices/${TEST_PREFIX}grpcwallet-account-service
          weight: 100
        faultInjectionPolicy:
          abort:
            httpStatus: 400
            percentage: 30


  - defaultService: projects/${PROJECT_ID}/global/backendServices/${TEST_PREFIX}grpcwallet-stats-service
    name: grpcwallet-stats-path-matcher
    routeRules:
      - matchRules:
          - prefixMatch: /
            headerMatches:
              - headerName: membership
                exactMatch: premium
        priority: 0
        service: projects/${PROJECT_ID}/global/backendServices/${TEST_PREFIX}grpcwallet-stats-premium-service

  - defaultService: projects/${PROJECT_ID}/global/backendServices/${TEST_PREFIX}grpcwallet-wallet-v1-service
    name: grpcwallet-wallet-path-matcher
    routeRules:
      - matchRules:
        - prefixMatch: /
          headerMatches:
          - headerName: route
            exactMatch: fault
        priority: 0
        routeAction:
          weightedBackendServices:
          - backendService: projects/${PROJECT_ID}/global/backendServices/{TEST_PREFIX}grpcwallet-wallet-v2-service
            weight: 100
          faultInjectionPolicy:
            abort:
              httpStatus: 503
              percentage: 50


      - matchRules:
        - fullPathMatch: /grpc.examples.wallet.Wallet/FetchBalance
          headerMatches:
          - headerName: membership
            exactMatch: premium
        priority: 1
        routeAction:
          weightedBackendServices:
          - backendService: projects/${PROJECT_ID}/global/backendServices/${TEST_PREFIX}grpcwallet-wallet-v2-service
            weight: 40
          - backendService: projects/${PROJECT_ID}/global/backendServices/${TEST_PREFIX}grpcwallet-wallet-v1-service
            weight: 60
          retryPolicy:
            retryConditions:
            - internal
            numRetries: 3

      - matchRules:
          - fullPathMatch: /grpc.examples.wallet.Wallet/FetchBalance
        priority: 2
        routeAction:
          weightedBackendServices:
            - backendService: projects/${PROJECT_ID}/global/backendServices/${TEST_PREFIX}grpcwallet-wallet-v2-service
              weight: 40
            - backendService: projects/${PROJECT_ID}/global/backendServices/${TEST_PREFIX}grpcwallet-wallet-v1-service
              weight: 60
      - matchRules:
          - prefixMatch: /grpc.examples.wallet.Wallet/
        priority: 3
        routeAction:
          weightedBackendServices:
            - backendService: projects/${PROJECT_ID}/global/backendServices/${TEST_PREFIX}grpcwallet-wallet-v2-service
              weight: 100
